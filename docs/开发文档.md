# AI智能构图相机 - 开发文档

## 架构设计

### 整体架构

```
┌─────────────────────────────────────────┐
│           用户界面层 (UI Layer)          │
│  - CameraScreen: 相机主界面              │
│  - SettingsScreen: 设置界面              │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│         业务逻辑层 (Logic Layer)         │
│  - CameraManager: 相机管理               │
│  - LocalAnalyzer: 本地AI分析             │
│  - TencentCloudAPI: 云端API              │
│  - GridOverlay: 辅助线绘制               │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│         数据层 (Data Layer)              │
│  - Config: 配置管理                      │
│  - Models: AI模型文件                    │
└─────────────────────────────────────────┘
```

### 数据流

```
相机画面 → 帧捕获 → 本地分析 → UI更新
                      ↓
                  用户触发
                      ↓
                  云端分析 → UI更新
```

## 核心模块详解

### 1. CameraManager (相机管理)

**职责：**
- 初始化相机
- 管理相机预览
- 捕获画面帧
- 拍摄照片

**关键方法：**
```python
initialize()           # 初始化相机
start_preview()        # 开始预览
stop_preview()         # 停止预览
capture_photo()        # 拍摄照片
_capture_frame()       # 捕获帧（定时调用）
```

**性能优化：**
- 使用定时器控制帧率（默认2fps）
- 异步处理避免阻塞UI
- 及时释放资源

### 2. LocalAnalyzer (本地分析)

**职责：**
- 实时分析画面
- 检测主体位置
- 检测水平线
- 计算美学评分
- 生成构图建议

**分析流程：**
```python
analyze_frame(frame)
    ├─ _detect_subject()      # OpenCV边缘检测
    ├─ _detect_horizon()      # 霍夫直线检测
    ├─ _analyze_brightness()  # 亮度分析
    ├─ _calculate_aesthetic_score()  # 评分计算
    └─ _generate_suggestions()       # 生成建议
```

**算法说明：**

1. **主体检测**
   - Canny边缘检测
   - 轮廓查找
   - 选择最大轮廓作为主体

2. **水平线检测**
   - 霍夫直线变换
   - 筛选接近水平的线
   - 计算倾斜角度

3. **评分算法**（简化版）
   ```python
   基础分: 5.0
   + 亮度适中: +1.0
   + 对比度良好: +1.0
   + 边缘清晰: +1.0
   = 总分 (0-10)
   ```

### 3. TencentCloudAPI (云端API)

**职责：**
- 调用腾讯云图像分析API
- 图片压缩和编码
- 结果解析
- 配额管理

**API调用流程：**
```python
analyze_image(frame)
    ├─ _compress_image()    # 压缩到500KB以内
    ├─ _encode_image()      # Base64编码
    ├─ _call_api()          # HTTP请求
    └─ _parse_result()      # 解析返回
```

**注意事项：**
- 需要配置API密钥
- 注意配额限制（10000次/月）
- 处理网络异常
- 实现请求超时

### 4. GridOverlay (辅助线)

**职责：**
- 绘制三分法网格
- 绘制黄金分割线
- 绘制水平参考线
- 绘制主体标记框

**绘制方法：**
```python
draw_rule_of_thirds()   # 三分法
draw_golden_ratio()     # 黄金分割
draw_horizon_line()     # 水平线
draw_subject_box()      # 主体框
```

## 配置系统

### config.json 结构

```json
{
  "app": {
    "name": "应用名称",
    "version": "版本号"
  },
  "camera": {
    "preview_resolution": [宽, 高],
    "capture_resolution": [宽, 高]
  },
  "local_analysis": {
    "enabled": true/false,
    "analysis_fps": 帧率,
    "model_path": "模型路径"
  },
  "tencent_cloud": {
    "api_key": "密钥",
    "enabled": true/false
  },
  "ui": {
    "show_grid": true/false,
    "show_score": true/false
  }
}
```

## 性能优化

### 1. 帧率控制
```python
# 降低分析频率，减少CPU占用
analysis_fps = 2  # 每秒分析2帧
```

### 2. 异步处理
```python
# 使用Clock.schedule_once避免阻塞
Clock.schedule_once(lambda dt: self.do_analysis(), 0.1)
```

### 3. 图片压缩
```python
# 云端API前压缩图片
max_dimension = 1024
quality = 85
```

### 4. 资源释放
```python
# 及时释放相机资源
def on_leave(self):
    self.camera_manager.release()
```

## Android打包

### 环境准备

```bash
# 安装buildozer
pip install buildozer

# 安装Android SDK和NDK
# 参考：https://buildozer.readthedocs.io/
```

### 打包命令

```bash
# 调试版本
buildozer android debug

# 发布版本
buildozer android release

# 部署到设备
buildozer android deploy run
```

### 常见问题

1. **权限问题**
   - 确保buildozer.spec中配置了所需权限
   - CAMERA, WRITE_EXTERNAL_STORAGE等

2. **依赖问题**
   - opencv-python在Android上需要特殊处理
   - 可能需要使用opencv-python-headless

3. **模型文件**
   - 确保.tflite文件包含在打包中
   - 在source.include_exts中添加tflite

## 扩展开发

### 添加新的构图规则

1. 在`composition/`目录创建新模块
2. 实现规则检测逻辑
3. 在LocalAnalyzer中集成
4. 在GridOverlay中添加可视化

### 集成NIMA模型

1. 下载预训练模型
2. 转换为TensorFlow Lite格式
3. 创建`src/ai/nima_model.py`
4. 在LocalAnalyzer中调用

示例代码：
```python
import tensorflow as tf

class NIMAModel:
    def __init__(self, model_path):
        self.interpreter = tf.lite.Interpreter(model_path)
        self.interpreter.allocate_tensors()
    
    def predict(self, image):
        # 预处理
        input_data = self.preprocess(image)
        
        # 推理
        self.interpreter.set_tensor(input_index, input_data)
        self.interpreter.invoke()
        output = self.interpreter.get_tensor(output_index)
        
        return self.postprocess(output)
```

### 添加其他云端API

1. 创建新的API客户端类
2. 实现统一的接口
3. 在UI中添加选择选项

## 测试

### 单元测试

```bash
# 运行测试
python -m pytest tests/
```

### 手动测试清单

- [ ] 相机预览正常
- [ ] 辅助线显示正确
- [ ] 实时评分更新
- [ ] 云端API调用成功
- [ ] 照片保存成功
- [ ] 设置功能正常
- [ ] 权限请求正常

## 发布流程

1. 更新版本号
2. 测试所有功能
3. 打包发布版本
4. 签名APK
5. 上传到应用商店

## 维护

### 日志查看

```bash
# Android日志
adb logcat | grep python
```

### 性能监控

- 使用Android Profiler
- 监控CPU和内存使用
- 优化热点代码

## 参考资料

- Kivy文档：https://kivy.org/doc/stable/
- OpenCV文档：https://docs.opencv.org/
- 腾讯云API：https://cloud.tencent.com/document/product/
- NIMA论文：https://arxiv.org/abs/1709.05424
